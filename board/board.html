<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="../img/로고.png">
  <title>자유게시판</title>
  <style>
    * { box-sizing: border-box; font-family: 'Pretendard','Noto Sans KR',sans-serif; }
    body { background-color: #f8f9fb; margin: 0; color: #333; }

    .header {
      display: flex;
      justify-content: center;  /* 가운데 정렬 */
      align-items: center;
      border-bottom: 2px solid #3B82F6;
      padding-bottom: 10px;
      margin-bottom: 20px;
      gap: 30px; /* 요소 간 간격 */
    }

    .logo {
      height: 40px;
      cursor: pointer;
    }

    .board-title {
      color: #3B82F6;
      font-size: 1.8em;
      margin: 0;
    }

    .header .btn {
      background-color: #3B82F6;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .header .btn:hover {
      background-color: #2563eb;
    }

    .container {
      max-width: 1000px;
      margin: 50px auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 30px 40px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #3B82F6;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    .header h1 { color: #3B82F6; margin: 0; }

    .btn {
      background-color: #3B82F6;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 8px 16px;
      cursor: pointer;
      transition: background 0.2s;
      margin: 2px;
    }
    .btn:hover { background-color: #2563eb; }
    .btn:disabled { background-color: #cbd5e1; cursor: not-allowed; }

    #list-page table {
      width: 100%;
      border-collapse: collapse;
      text-align: center;
    }
    #list-page th, #list-page td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    #list-page thead { background-color: #f1f5f9; }
    #list-page td.title { text-align: left; color: #1d4ed8; cursor: pointer; }
    #list-page td.title:hover { text-decoration: underline; }

    #write-page, #view-page { display: none; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #555; }
    .form-group input[type="text"], .form-group textarea {
      width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 5px;
    }
    .form-group textarea { min-height: 250px; resize: none; }
    .button-box { display: flex; justify-content: flex-end; gap: 10px; }
    .cancel-btn { background-color: #e5e7eb; color: #333; }
    .cancel-btn:hover { background-color: #d1d5db; }

    .view-field { margin-bottom: 20px; }
    .view-label { font-weight: bold; color: #555; }
    .view-content {
      background: #f9fafb;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 12px;
      white-space: pre-wrap;
      min-height: 150px;
    }

    #pagination { text-align: center; margin-top: 20px; }
  </style>
</head>
<body>

  <!-- ✅ 게시판 목록 -->
  <div class="container" id="list-page">
    <div class="header">
      <img src="../img/KakaoTalk_20251111_154721082.png" alt="내방" class="logo" onclick="location.href='../main/01_main.html'">
      <h1 class="board-title">자유게시판</h1>
      <button class="btn" onclick="showWritePage()">글쓰기</button>
    </div>


    <table id="postTable">
      <thead>
        <tr>
          <th>번호</th><th>제목</th><th>작성자</th><th>날짜</th><th>조회수</th>
        </tr>
      </thead>
      <tbody id="postList"></tbody>
    </table>

    <div id="pagination"></div>
  </div>

  <!-- ✅ 글쓰기 -->
  <div class="container" id="write-page">
    <div class="header">
      <h1>글쓰기</h1>
      <button class="btn cancel-btn" onclick="showListPage()">뒤로가기</button>
    </div>

    <form id="postForm">
      <div class="form-group">
        <label for="title">제목</label>
        <input type="text" id="title" placeholder="제목을 입력하세요" required>
      </div>

      <div class="form-group">
        <label for="author">작성자</label>
        <input type="text" id="author" readonly>
      </div>

      <div class="form-group">
        <label for="content">내용</label>
        <textarea id="content" placeholder="내용을 입력하세요"></textarea>
      </div>

      <div class="button-box">
        <button type="submit" class="btn">저장</button>
        <button type="button" class="btn cancel-btn" onclick="showListPage()">취소</button>
      </div>
    </form>
  </div>

  <!-- ✅ 상세보기 -->
  <div class="container" id="view-page">
    <div class="header">
      <h1>게시글 보기</h1>
      <button class="btn cancel-btn" onclick="showListPage()">목록으로</button>
    </div>

    <div class="view-field">
      <div class="view-label">제목</div>
      <div id="view-title" class="view-content"></div>
    </div>
    <div class="view-field">
      <div class="view-label">작성자</div>
      <div id="view-author" class="view-content"></div>
    </div>
    <div class="view-field">
      <div class="view-label">내용</div>
      <div id="view-content" class="view-content"></div>
    </div>
    <div class="button-box">
      <button class="btn" onclick="showWritePage(true)">수정</button>
      <button class="btn cancel-btn" onclick="deletePost()">삭제</button>
    </div>
  </div>

  <script>
    let posts = [];
    let currentPostId = null;
    const postsPerPage = 5;
    let currentPage = 1;

    window.onload = function() {
  // ✅ 사용자 이름 가져오기
  const statusJson = localStorage.getItem("status");
  let userName = "익명";

  if (statusJson) {
    try {
      const statusObj = JSON.parse(statusJson);
      if (statusObj && statusObj.name) userName = statusObj.name;
    } catch (e) {
      console.warn("status 파싱 실패:", e);
    }
  }

  localStorage.setItem("name", userName);

  // ✅ 게시글 데이터는 따로 가져오기
  const savedPosts = localStorage.getItem("posts");
  posts = savedPosts ? JSON.parse(savedPosts) : [];

  // posts가 배열이 아닐 경우 강제 초기화
  if (!Array.isArray(posts)) posts = [];

  savePosts();
  renderPosts();
};


    function savePosts() {
      localStorage.setItem("posts", JSON.stringify(posts));
      
      console.log('set localStorage' + JSON.parse(localStorage.getItem("status")).name );
      console.log('posts.name : ' + localStorage.getItem("name"));
    }

    function showWritePage(editMode = false) {
  document.getElementById('list-page').style.display = 'none';
  document.getElementById('view-page').style.display = 'none';
  document.getElementById('write-page').style.display = 'block';

  // ✅ 작성자 자동 채우기
  const authorInput = document.getElementById('author');
  let userName = "익명";
  const statusJson = localStorage.getItem("status");
  if (statusJson) {
    try {
      const statusObj = JSON.parse(statusJson);
      if (statusObj && statusObj.name) userName = statusObj.name;
    } catch (e) {}
  }
  authorInput.value = userName;
  authorInput.readOnly = true;

  if (editMode && currentPostId) {
    const post = posts.find(p => p.id === currentPostId);
    document.getElementById('title').value = post.title;
    document.getElementById('content').value = post.content;
  } else {
    document.getElementById('postForm').reset();
    document.getElementById('author').value = userName;
    currentPostId = null;
  }
}


    function showListPage() {
      document.getElementById('write-page').style.display = 'none';
      document.getElementById('view-page').style.display = 'none';
      document.getElementById('list-page').style.display = 'block';
      renderPosts();
    }

    function showViewPage(id) {
      const post = posts.find(p => p.id === id);
      if (!post) return;
      currentPostId = id;
      post.views++;
      savePosts();

      document.getElementById('view-title').innerText = post.title;
      document.getElementById('view-author').innerText = post.author;
      document.getElementById('view-content').innerText = post.content;

      document.getElementById('list-page').style.display = 'none';
      document.getElementById('write-page').style.display = 'none';
      document.getElementById('view-page').style.display = 'block';
    }

    function renderPagination(totalPosts) {
      const totalPages = Math.ceil(totalPosts / postsPerPage);
      const paginationContainer = document.getElementById('pagination');
      paginationContainer.innerHTML = "";

      const prevBtn = document.createElement('button');
      prevBtn.textContent = "이전";
      prevBtn.disabled = currentPage === 1;
      prevBtn.className = "btn";
      prevBtn.onclick = () => { currentPage--; renderPosts(); };
      paginationContainer.appendChild(prevBtn);

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = "btn";
        if (i === currentPage) btn.style.backgroundColor = "#2563eb";
        btn.onclick = () => { currentPage = i; renderPosts(); };
        paginationContainer.appendChild(btn);
      }

      const nextBtn = document.createElement('button');
      nextBtn.textContent = "다음";
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.className = "btn";
      nextBtn.onclick = () => { currentPage++; renderPosts(); };
      paginationContainer.appendChild(nextBtn);
    }

    function renderPosts() {
  const postList = document.getElementById('postList');
  postList.innerHTML = "";

  // 안전하게 posts를 배열로 보장
  const postsArray = Array.isArray(posts) ? posts : [];

  // id가 숫자가 아닐 경우 대비해 Number()로 변환 (NaN이면 0 처리)
  const sorted = [...postsArray].sort((a, b) => {
    const idA = Number(a && a.id) || 0;
    const idB = Number(b && b.id) || 0;
    return idB - idA;
  });

  const start = (currentPage - 1) * postsPerPage;
  const end = start + postsPerPage;
  const pagePosts = sorted.slice(start, end);

  pagePosts.forEach(post => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${post.id}</td>
      <td class="title" onclick="showViewPage(${post.id})">${post.title}</td>
      <td>${post.author}</td>
      <td>${post.date}</td>
      <td>${post.views}</td>
    `;
    postList.appendChild(row);
  });

  renderPagination(sorted.length);
}

/*
    function renderPosts() {
      const postList = document.getElementById('postList');
      postList.innerHTML = "";
      const sorted = [...posts].sort((a, b) => b.id - a.id);
      const start = (currentPage - 1) * postsPerPage;
      const end = start + postsPerPage;
      const pagePosts = sorted.slice(start, end);

      pagePosts.forEach(post => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${post.id}</td>
          <td class="title" onclick="showViewPage(${post.id})">${post.title}</td>
          <td>${post.author}</td>
          <td>${post.date}</td>
          <td>${post.views}</td>
        `;
        postList.appendChild(row);
      });

      renderPagination(sorted.length);
    }
    */

    document.getElementById('postForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const title = document.getElementById('title').value.trim();
  const content = document.getElementById('content').value.trim();

  // ✅ 로컬스토리지에서 status.name 가져오기
  let author = "익명";
  const statusJson = localStorage.getItem("status");
  if (statusJson) {
    try {
      const statusObj = JSON.parse(statusJson);
      if (statusObj && statusObj.name) author = statusObj.name;
    } catch (err) {
      console.error("status 파싱 오류:", err);
    }
  }

  if (!title || !content) {
    alert("제목과 내용을 입력해주세요.");
    return;
  }

  // ✅ posts 배열 보장
  if (!Array.isArray(posts)) posts = [];

  if (currentPostId) {
    const post = posts.find(p => p.id === currentPostId);
    if (post) {
      post.title = title;
      post.content = content;
      alert("게시글이 수정되었습니다!");
    }
  } else {
    const newPost = {
      id: posts.length ? posts[posts.length - 1].id + 1 : 1,
      title,
      author, // ✅ 작성자 이름 자동 입력
      content,
      date: new Date().toISOString().split('T')[0],
      views: 0
    };
    posts.push(newPost);
    alert("게시글이 등록되었습니다!");
  }

  savePosts();
  showListPage();
});



    function deletePost() {
      if (!currentPostId) return;
      if (confirm("정말 이 게시글을 삭제하시겠습니까?")) {
        posts = posts.filter(p => p.id !== currentPostId);
        savePosts();
        alert("게시글이 삭제되었습니다.");
        showListPage();
      }
    }
  </script>
</body>
</html>
